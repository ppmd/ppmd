

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pairloop &mdash; src  documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="src  documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">src  documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pairloop</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">particle</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="k">class</span> <span class="nc">_base</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">_unique_name_calc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return name which can be used to identify the pair loop </span>
<span class="sd">        in a unique way.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kernel</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s">&#39;_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">hexdigest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create unique hex digest&#39;&#39;&#39;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
        <span class="n">m</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_kernel</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_code</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">_generate_header_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Generate the source code of the header file.</span>

<span class="sd">        Returns the source code for the header file.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">code</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">        #ifndef </span><span class="si">%(UNIQUENAME)s</span><span class="s">_H</span>
<span class="s">        #define </span><span class="si">%(UNIQUENAME)s</span><span class="s">_H </span><span class="si">%(UNIQUENAME)s</span><span class="s">_H</span>

<span class="s">        </span><span class="si">%(INCLUDED_HEADERS)s</span><span class="s"></span>

<span class="s">        void </span><span class="si">%(KERNEL_NAME)s</span><span class="s">_wrapper(int n,</span><span class="si">%(ARGUMENTS)s</span><span class="s">);</span>

<span class="s">        #endif</span>
<span class="s">        &#39;&#39;&#39;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;UNIQUENAME&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_name</span><span class="p">,</span>
             <span class="s">&#39;INCLUDED_HEADERS&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_included_headers</span><span class="p">(),</span>
             <span class="s">&#39;KERNEL_NAME&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_kernel</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
             <span class="s">&#39;ARGUMENTS&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_argnames</span><span class="p">()}</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">code</span> <span class="o">%</span> <span class="n">d</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_included_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return names of included header files.&#39;&#39;&#39;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;#include </span><span class="se">\&quot;</span><span class="s">&#39;</span><span class="o">+</span><span class="n">x</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\&quot;</span><span class="s"> </span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="k">return</span> <span class="n">s</span>    
    
    <span class="k">def</span> <span class="nf">_argnames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Comma separated string of argument name declarations.</span>

<span class="sd">        This string of argument names is used in the declaration of </span>
<span class="sd">        the method which executes the pairloop over the grid. </span>
<span class="sd">        If, for example, the pairloop gets passed two particle_dats, </span>
<span class="sd">        then the result will be ``double** arg_000,double** arg_001`.`</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c">#argnames = &#39;&#39;</span>
        <span class="c">#for i in range(self._nargs):</span>
        <span class="c">#    argnames += &#39;double **arg_&#39;+(&#39;%03d&#39; % i)+&#39;,&#39;</span>
        <span class="c">#return argnames[:-1]</span>
        
        <span class="n">argnames</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">dat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_particle_dat_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">argnames</span> <span class="o">+=</span> <span class="s">&#39;double *arg_&#39;</span><span class="o">+</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%03d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;,&#39;</span>
            
            
            <span class="c">#if (dat[1].dattype  == &#39;scalar&#39;):</span>
                <span class="c">#argnames += &#39;double *arg_&#39;+(&#39;%03d&#39; % i)+&#39;,&#39;</span>
            
            <span class="c">#if (dat[1].dattype  == &#39;array&#39;):        </span>
                <span class="c">#argnames += &#39;double **arg_&#39;+(&#39;%03d&#39; % i)+&#39;,&#39;</span>

        <span class="k">return</span> <span class="n">argnames</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        

    <span class="k">def</span> <span class="nf">_generate_impl_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Generate the source code the actual implementation.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;UNIQUENAME&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_name</span><span class="p">,</span>
             <span class="s">&#39;KERNEL_METHODNAME&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_kernel_methodname</span><span class="p">(),</span>
             <span class="s">&#39;KERNEL&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_kernel</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
             <span class="s">&#39;ARGUMENTS&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_argnames</span><span class="p">(),</span>
             <span class="s">&#39;LOC_ARGUMENTS&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_loc_argnames</span><span class="p">(),</span>
             <span class="s">&#39;KERNEL_NAME&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_kernel</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
             <span class="s">&#39;KERNEL_ARGUMENT_DECL&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_kernel_argument_declarations</span><span class="p">()}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_code</span> <span class="o">%</span> <span class="n">d</span>    

    <span class="k">def</span> <span class="nf">_kernel_methodname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Construct the name of the kernel method.</span>
<span class="sd">        </span>
<span class="sd">        Return a string of the form </span>
<span class="sd">        ``inline void kernel_name(double **&lt;arg1&gt;, double *&lt;arg2}, ...) {``</span>
<span class="sd">        which is used for defining the name of the kernel method.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">space</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">*</span><span class="mi">14</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;inline void &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_kernel</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s">&#39;(&#39;</span>
        <span class="k">for</span> <span class="n">var_name_kernel</span><span class="p">,</span> <span class="n">var_name_state</span>  <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_particle_dat_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c">#print var_name_kernel, var_name_state.dattype()</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">var_name_state</span><span class="o">.</span><span class="n">dattype</span><span class="o">==</span><span class="s">&#39;array&#39;</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;double **&#39;</span><span class="o">+</span><span class="n">var_name_kernel</span><span class="o">+</span><span class="s">&#39;, &#39;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">var_name_state</span><span class="o">.</span><span class="n">dattype</span><span class="o">==</span><span class="s">&#39;scalar&#39;</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;double *&#39;</span><span class="o">+</span><span class="n">var_name_kernel</span><span class="o">+</span><span class="s">&#39;, &#39;</span>
            
            
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;) {&#39;</span>
        <span class="k">return</span> <span class="n">s</span>           

    <span class="k">def</span> <span class="nf">_loc_argnames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Comma separated string of local argument names.</span>

<span class="sd">        This string is used in the call to the local kernel. If, for</span>
<span class="sd">        example, two particle dats get passed to the pairloop, then</span>
<span class="sd">        the result will be ``loc_arg_000,loc_arg_001``. Each of these</span>
<span class="sd">        is of required type, see method _kernel_argument_declarations()</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">argnames</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nargs</span><span class="p">):</span>
            <span class="n">argnames</span> <span class="o">+=</span> <span class="s">&#39;loc_arg_&#39;</span><span class="o">+</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%03d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;,&#39;</span>
        <span class="k">return</span> <span class="n">argnames</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>




    <span class="k">def</span> <span class="nf">_kernel_argument_declarations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Define and declare the kernel arguments.</span>

<span class="sd">        For each argument the kernel gets passed a pointer of type</span>
<span class="sd">        ``double* loc_argXXX[2]``. Here ``loc_arg[i]`` with i=0,1 is</span>
<span class="sd">        pointer to the data which contains the properties of particle i.</span>
<span class="sd">        These properties are stored consecutively in memory, so for a </span>
<span class="sd">        scalar property only ``loc_argXXX[i][0]`` is used, but for a vector</span>
<span class="sd">        property the vector entry j of particle i is accessed as </span>
<span class="sd">        ``loc_argXXX[i][j]``.</span>

<span class="sd">        This method generates the definitions of the ``loc_argXXX`` variables</span>
<span class="sd">        and populates the data to ensure that ``loc_argXXX[i]`` points to</span>
<span class="sd">        the correct address in the particle_dats.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">dat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_particle_dat_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            
            
            <span class="n">space</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">*</span><span class="mi">14</span>
            <span class="n">argname</span> <span class="o">=</span> <span class="s">&#39;arg_&#39;</span><span class="o">+</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%03d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">loc_argname</span> <span class="o">=</span> <span class="s">&#39;loc_&#39;</span><span class="o">+</span><span class="n">argname</span>
            
            
            <span class="k">if</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dattype</span>  <span class="o">==</span> <span class="s">&#39;scalar&#39;</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">space</span><span class="o">+</span><span class="s">&#39;double *&#39;</span><span class="o">+</span><span class="n">loc_argname</span><span class="o">+</span><span class="s">&#39; = &#39;</span><span class="o">+</span><span class="n">argname</span><span class="o">+</span><span class="s">&#39;;</span><span class="se">\n</span><span class="s">&#39;</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dattype</span>  <span class="o">==</span> <span class="s">&#39;array&#39;</span><span class="p">):</span>
                <span class="n">ncomp</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ncomp</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">space</span><span class="o">+</span><span class="s">&#39;double *&#39;</span><span class="o">+</span><span class="n">loc_argname</span><span class="o">+</span><span class="s">&#39;[2];</span><span class="se">\n</span><span class="s">&#39;</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">space</span><span class="o">+</span><span class="n">loc_argname</span><span class="o">+</span><span class="s">&#39;[0] = &#39;</span><span class="o">+</span><span class="n">argname</span><span class="o">+</span><span class="s">&#39;+&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ncomp</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;*i;</span><span class="se">\n</span><span class="s">&#39;</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">space</span><span class="o">+</span><span class="n">loc_argname</span><span class="o">+</span><span class="s">&#39;[1] = &#39;</span><span class="o">+</span><span class="n">argname</span><span class="o">+</span><span class="s">&#39;+&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ncomp</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;*j;</span><span class="se">\n</span><span class="s">&#39;</span>       
        
        <span class="k">return</span> <span class="n">s</span> 

<div class="viewcode-block" id="PairLoopRapaport_tmp"><a class="viewcode-back" href="../pairloop.html#pairloop.PairLoopRapaport_tmp">[docs]</a><span class="k">class</span> <span class="nc">PairLoopRapaport_tmp</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Class to implement rapaport 14 cell looping, Use PairLoopRapaport instead.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">input_state</span><span class="p">):</span>
        
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span> <span class="o">=</span> <span class="n">input_state</span>
        
        <span class="sd">&#39;&#39;&#39;Construct initial cell list&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_q_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">N</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">domain</span><span class="p">()</span><span class="o">.</span><span class="n">cell_count</span><span class="p">()],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_sort_all</span><span class="p">()</span>
        

        
        <span class="sd">&#39;&#39;&#39;Determine cell neighbours&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cell_map</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">14</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">domain</span><span class="p">()</span><span class="o">.</span><span class="n">cell_count</span><span class="p">(),</span><span class="mi">5</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">domain</span><span class="p">()</span><span class="o">.</span><span class="n">cell_count</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cell_map</span><span class="p">[(</span><span class="n">cp</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">14</span><span class="p">:(</span><span class="n">cp</span><span class="o">*</span><span class="mi">14</span><span class="p">),</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_adjacent_cells</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span>
        
        
        
        <span class="sd">&#39;&#39;&#39;Initialise pair_loop code&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_libpair_loop_LJ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ctypeslib</span><span class="o">.</span><span class="n">load_library</span><span class="p">(</span><span class="s">&#39;libpair_loop_LJ.so&#39;</span><span class="p">,</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_libpair_loop_LJ</span><span class="o">.</span><span class="n">d_pair_loop_LJ</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span>
        
        <span class="c">#void d_pair_loop_LJ(int N, int cell_count, double rc, int* cells, int* q_list, double* pos, double* d_extent, double *accel);</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_libpair_loop_LJ</span><span class="o">.</span><span class="n">d_pair_loop_LJ</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span>
                                                        <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span>
                                                        <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">,</span>
                                                        <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">),</span>
                                                        <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">),</span>
                                                        <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                                                        <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                                                        <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">),</span>
                                                        <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">)]</span>
        
        
        
    <span class="k">def</span> <span class="nf">_arg_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>    
        <span class="bp">self</span><span class="o">.</span><span class="n">_args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_cell_map</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">)),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_q_list</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">)),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">positions</span><span class="p">()</span><span class="o">.</span><span class="n">Dat</span><span class="p">()</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">)),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">domain</span><span class="p">()</span><span class="o">.</span><span class="n">extent</span><span class="p">()</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">)),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">accelerations</span><span class="p">()</span><span class="o">.</span><span class="n">Dat</span><span class="p">()</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">)),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">U</span><span class="p">()</span><span class="o">.</span><span class="n">ctypes_data</span><span class="p">()]</span>
        
        
    
        
        
     
    <span class="k">def</span> <span class="nf">_update_prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c">#handle perodic bounadies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">domain</span><span class="p">()</span><span class="o">.</span><span class="n">boundary_correct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="p">)</span>
        <span class="c">#update cell list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_sort_all</span><span class="p">()</span>
        
        
<div class="viewcode-block" id="PairLoopRapaport_tmp.execute"><a class="viewcode-back" href="../pairloop.html#pairloop.PairLoopRapaport_tmp.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        C version of the pair_locate: Loop over all cells update accelerations and potential engery.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_prepare</span><span class="p">()</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">set_accelerations</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">reset_U</span><span class="p">()</span> <span class="c">#causes segfault.....</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_arg_update</span><span class="p">()</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">_libpair_loop_LJ</span><span class="o">.</span><span class="n">d_pair_loop_LJ</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">N</span><span class="p">()),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">domain</span><span class="p">()</span><span class="o">.</span><span class="n">cell_count</span><span class="p">()),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">_potential</span><span class="o">.</span><span class="n">_rc</span><span class="p">),</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">)</span>   
        
        
        </div>
<div class="viewcode-block" id="PairLoopRapaport_tmp.cell_sort_all"><a class="viewcode-back" href="../pairloop.html#pairloop.PairLoopRapaport_tmp.cell_sort_all">[docs]</a>    <span class="k">def</span> <span class="nf">cell_sort_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct neighbour list, assigning atoms to cells. Using Rapaport alg.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">cx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">domain</span><span class="p">()</span><span class="o">.</span><span class="n">cell_count</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_q_list</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">N</span><span class="p">()</span> <span class="o">+</span> <span class="n">cx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">N</span><span class="p">()):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">domain</span><span class="p">()</span><span class="o">.</span><span class="n">get_cell_lin_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">positions</span><span class="p">()</span><span class="o">.</span><span class="n">Dat</span><span class="p">()[</span><span class="n">ix</span><span class="o">-</span><span class="mi">1</span><span class="p">,])</span>
            
            <span class="c">#print c, self._pos[ix-1,], self._domain._extent*0.5</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_q_list</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q_list</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">N</span><span class="p">()</span> <span class="o">+</span> <span class="n">c</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_q_list</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">N</span><span class="p">()</span> <span class="o">+</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">ix</span>
            
    
       </div>
<div class="viewcode-block" id="PairLoopRapaport_tmp.get_adjacent_cells"><a class="viewcode-back" href="../pairloop.html#pairloop.PairLoopRapaport_tmp.get_adjacent_cells">[docs]</a>    <span class="k">def</span> <span class="nf">get_adjacent_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the 14 neighbouring cells as linear index.</span>
<span class="sd">        </span>
<span class="sd">        :arg ix: (int) Input index.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
         
        <span class="n">cell_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">14</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
        <span class="c">#cell_list_boundary=[]</span>
        
        <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">domain</span><span class="p">()</span><span class="o">.</span><span class="n">cell_index_tuple</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span>
        
        <span class="n">stencil_map</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">14</span><span class="p">):</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">stencil_map</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
            
            <span class="n">cell_list</span><span class="p">[</span><span class="n">ix</span><span class="p">,]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">domain</span><span class="p">()</span><span class="o">.</span><span class="n">cell_index_lin_offset</span><span class="p">(</span><span class="n">C</span><span class="o">+</span><span class="n">ind</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cell_list</span>

<span class="c">################################################################################################################</span>
<span class="c"># RAPAPORT LOOP SERIAL</span>
<span class="c">################################################################################################################</span>
</div></div>
<div class="viewcode-block" id="PairLoopRapaport"><a class="viewcode-back" href="../pairloop.html#pairloop.PairLoopRapaport">[docs]</a><span class="k">class</span> <span class="nc">PairLoopRapaport</span><span class="p">(</span><span class="n">_base</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Class to implement rapaport 14 cell looping.</span>
<span class="sd">    </span>
<span class="sd">    :arg input_state: State containing data to loop over.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">input_state</span><span class="p">):</span>
         
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span> <span class="o">=</span> <span class="n">input_state</span>
        
        <span class="sd">&#39;&#39;&#39;Construct initial cell list&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_q_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">N</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">domain</span><span class="p">()</span><span class="o">.</span><span class="n">cell_count</span><span class="p">()],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_sort_all</span><span class="p">()</span>
        
        
        
        <span class="c">##########</span>
        <span class="c"># End of Rapaport initialisations.</span>
        <span class="c">##########</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_temp_dir</span> <span class="o">=</span> <span class="s">&#39;./build/&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_temp_dir</span><span class="p">)):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_temp_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kernel</span> <span class="o">=</span> <span class="n">input_state</span><span class="o">.</span><span class="n">potential</span><span class="p">()</span><span class="o">.</span><span class="n">kernel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_particle_dat_dict</span> <span class="o">=</span> <span class="n">input_state</span><span class="o">.</span><span class="n">potential</span><span class="p">()</span><span class="o">.</span><span class="n">datdict</span><span class="p">(</span><span class="n">input_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nargs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_particle_dat_dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="n">input_state</span><span class="o">.</span><span class="n">potential</span><span class="p">()</span><span class="o">.</span><span class="n">headers</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_code_init</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_unique_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unique_name_calc</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_library_filename</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unique_name</span> <span class="o">+</span><span class="s">&#39;.so&#39;</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_temp_dir</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_library_filename</span><span class="p">))):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_library</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lib</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ctypeslib</span><span class="o">.</span><span class="n">load_library</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_library_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temp_dir</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_generate_header_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Generate the source code of the header file.</span>

<span class="sd">        Returns the source code for the header file.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">code</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">        #ifndef </span><span class="si">%(UNIQUENAME)s</span><span class="s">_H</span>
<span class="s">        #define </span><span class="si">%(UNIQUENAME)s</span><span class="s">_H </span><span class="si">%(UNIQUENAME)s</span><span class="s">_H</span>

<span class="s">        </span><span class="si">%(INCLUDED_HEADERS)s</span><span class="s"></span>
<span class="s">        #define LINIDX_2D(NX,iy,ix)   ((NX)*(iy) + (ix))</span>
<span class="s">        #define sign(x) (((x) &lt; 0 ) ?  -1 : ((x) &gt; 0 ))</span>
<span class="s">        </span>
<span class="s">        void </span><span class="si">%(KERNEL_NAME)s</span><span class="s">_wrapper(const int n,const int cell_count, int* cells, int* q_list, double* d_extent,</span><span class="si">%(ARGUMENTS)s</span><span class="s">);</span>

<span class="s">        #endif</span>
<span class="s">        &#39;&#39;&#39;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;UNIQUENAME&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_name</span><span class="p">,</span>
             <span class="s">&#39;INCLUDED_HEADERS&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_included_headers</span><span class="p">(),</span>
             <span class="s">&#39;KERNEL_NAME&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_kernel</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
             <span class="s">&#39;ARGUMENTS&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_argnames</span><span class="p">()}</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">code</span> <span class="o">%</span> <span class="n">d</span><span class="p">)</span>
        
        
    <span class="k">def</span> <span class="nf">_code_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_code</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">        #include </span><span class="se">\&quot;</span><span class="si">%(UNIQUENAME)s</span><span class="s">.h</span><span class="se">\&quot;</span><span class="s"></span>
<span class="s">        </span>
<span class="s">        </span><span class="si">%(KERNEL_METHODNAME)s</span><span class="s"></span>
<span class="s">        </span><span class="si">%(KERNEL)s</span><span class="s"></span>
<span class="s">        }</span>
<span class="s">        </span>
<span class="s">        inline void cell_index_offset(const unsigned int cp, const unsigned int cpp_i, int* cell_array, double *d_extent, unsigned int* cpp, unsigned int *flag, double *offset){</span>
<span class="s">        </span>
<span class="s">            const int cell_map[14][3] = {   {0,0,0},</span>
<span class="s">                                            {1,0,0},</span>
<span class="s">                                            {0,1,0},</span>
<span class="s">                                            {1,1,0},</span>
<span class="s">                                            {1,-1,0},</span>
<span class="s">                                            {-1,1,1},</span>
<span class="s">                                            {0,1,1},</span>
<span class="s">                                            {1,1,1},</span>
<span class="s">                                            {-1,0,1},</span>
<span class="s">                                            {0,0,1},</span>
<span class="s">                                            {1,0,1},</span>
<span class="s">                                            {-1,-1,1},</span>
<span class="s">                                            {0,-1,1},</span>
<span class="s">                                            {1,-1,1}};     </span>
<span class="s">                </span>
<span class="s">                </span>
<span class="s">            unsigned int tmp = cell_array[0]*cell_array[1];    </span>
<span class="s">            int Cz = cp/tmp;</span>
<span class="s">            int Cx = cp </span><span class="si">%%</span><span class="s"> cell_array[0];</span>
<span class="s">            int Cy = (cp - Cz*tmp)/cell_array[0];</span>
<span class="s">            </span>
<span class="s">            </span>
<span class="s">            Cx += cell_map[cpp_i][0];</span>
<span class="s">            Cy += cell_map[cpp_i][1];</span>
<span class="s">            Cz += cell_map[cpp_i][2];</span>
<span class="s">            </span>
<span class="s">            int C0 = (Cx + cell_array[0]) </span><span class="si">%%</span><span class="s"> cell_array[0];    </span>
<span class="s">            int C1 = (Cy + cell_array[1]) </span><span class="si">%%</span><span class="s"> cell_array[1];</span>
<span class="s">            int C2 = (Cz + cell_array[2]) </span><span class="si">%%</span><span class="s"> cell_array[2];</span>
<span class="s">                </span>
<span class="s">             </span>
<span class="s">            if ((Cx != C0) || (Cy != C1) || (Cz != C2)) { </span>
<span class="s">                *flag = 1;</span>
<span class="s">                offset[0] = ((double)sign(Cx - C0))*d_extent[0];</span>
<span class="s">                offset[1] = ((double)sign(Cy - C1))*d_extent[1];</span>
<span class="s">                offset[2] = ((double)sign(Cz - C2))*d_extent[2];</span>
<span class="s">                </span>
<span class="s">                </span>
<span class="s">                </span>
<span class="s">            } else {*flag = 0; }</span>
<span class="s">            </span>
<span class="s">            *cpp = (C2*cell_array[1] + C1)*cell_array[0] + C0;</span>
<span class="s">            </span>
<span class="s">            </span>
<span class="s">                </span>
<span class="s">            return;      </span>
<span class="s">        }    </span>
<span class="s">        </span>
<span class="s">        void </span><span class="si">%(KERNEL_NAME)s</span><span class="s">_wrapper(const int n, const int cell_count, int* cell_array, int* q_list, double* d_extent,</span><span class="si">%(ARGUMENTS)s</span><span class="s">) { </span>
<span class="s">            </span>
<span class="s">            for(unsigned int cp = 0; cp &lt; cell_count; cp++){</span>
<span class="s">                for(unsigned int cpp_i=0; cpp_i&lt;14; cpp_i++){</span>
<span class="s">                </span>
<span class="s">                    double s[3]; </span>
<span class="s">                    unsigned int flag, cpp; </span>
<span class="s">                    int i,j;</span>
<span class="s">                    </span>
<span class="s">                    cell_index_offset(cp, cpp_i, cell_array, d_extent, &amp;cpp, &amp;flag, s);</span>
<span class="s">                    </span>
<span class="s">                    </span>
<span class="s">                    double r1[3];</span>
<span class="s">                    </span>
<span class="s">                    i = q_list[n+cp];</span>
<span class="s">                    while (i &gt; -1){</span>
<span class="s">                        j = q_list[n+cpp];</span>
<span class="s">                        while (j &gt; -1){</span>
<span class="s">                            if (cp != cpp || i &lt; j){</span>
<span class="s">        </span>
<span class="s">                                </span><span class="si">%(KERNEL_ARGUMENT_DECL)s</span><span class="s"></span>
<span class="s">                                </span><span class="si">%(KERNEL_NAME)s</span><span class="s">(</span><span class="si">%(LOC_ARGUMENTS)s</span><span class="s">);</span>
<span class="s">                                </span>
<span class="s">                                </span>
<span class="s">                            }</span>
<span class="s">                            j = q_list[j];  </span>
<span class="s">                        }</span>
<span class="s">                        i=q_list[i];</span>
<span class="s">                    }</span>
<span class="s">                }</span>
<span class="s">            }</span>
<span class="s">            </span>
<span class="s">            </span>
<span class="s">            return;</span>
<span class="s">        }        </span>
<span class="s">        </span>
<span class="s">        </span>
<span class="s">        &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">_kernel_argument_declarations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Define and declare the kernel arguments.</span>

<span class="sd">        For each argument the kernel gets passed a pointer of type</span>
<span class="sd">        ``double* loc_argXXX[2]``. Here ``loc_arg[i]`` with i=0,1 is</span>
<span class="sd">        pointer to the data which contains the properties of particle i.</span>
<span class="sd">        These properties are stored consecutively in memory, so for a </span>
<span class="sd">        scalar property only ``loc_argXXX[i][0]`` is used, but for a vector</span>
<span class="sd">        property the vector entry j of particle i is accessed as </span>
<span class="sd">        ``loc_argXXX[i][j]``.</span>

<span class="sd">        This method generates the definitions of the ``loc_argXXX`` variables</span>
<span class="sd">        and populates the data to ensure that ``loc_argXXX[i]`` points to</span>
<span class="sd">        the correct address in the particle_dats.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">dat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_particle_dat_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            
            
            <span class="n">space</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">*</span><span class="mi">14</span>
            <span class="n">argname</span> <span class="o">=</span> <span class="s">&#39;arg_&#39;</span><span class="o">+</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%03d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">loc_argname</span> <span class="o">=</span> <span class="s">&#39;loc_&#39;</span><span class="o">+</span><span class="n">argname</span>
            
            
            <span class="k">if</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dattype</span>  <span class="o">==</span> <span class="s">&#39;scalar&#39;</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">space</span><span class="o">+</span><span class="s">&#39;double *&#39;</span><span class="o">+</span><span class="n">loc_argname</span><span class="o">+</span><span class="s">&#39; = &#39;</span><span class="o">+</span><span class="n">argname</span><span class="o">+</span><span class="s">&#39;;</span><span class="se">\n</span><span class="s">&#39;</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dattype</span>  <span class="o">==</span> <span class="s">&#39;array&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>  <span class="o">==</span> <span class="s">&#39;positions&#39;</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">space</span><span class="o">+</span><span class="s">&#39;double *&#39;</span><span class="o">+</span><span class="n">loc_argname</span><span class="o">+</span><span class="s">&#39;[2];</span><span class="se">\n</span><span class="s">&#39;</span>
                    
                    
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">space</span><span class="o">+</span><span class="s">&#39;if (flag){ </span><span class="se">\n</span><span class="s">&#39;</span>

                    <span class="c">#s += space+&#39;double r1[3];\n&#39;</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">space</span><span class="o">+</span><span class="s">&#39;r1[0] =&#39;</span><span class="o">+</span><span class="n">argname</span><span class="o">+</span><span class="s">&#39;[LINIDX_2D(3,j,0)] + s[0]; </span><span class="se">\n</span><span class="s">&#39;</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">space</span><span class="o">+</span><span class="s">&#39;r1[1] =&#39;</span><span class="o">+</span><span class="n">argname</span><span class="o">+</span><span class="s">&#39;[LINIDX_2D(3,j,1)] + s[1]; </span><span class="se">\n</span><span class="s">&#39;</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">space</span><span class="o">+</span><span class="s">&#39;r1[2] =&#39;</span><span class="o">+</span><span class="n">argname</span><span class="o">+</span><span class="s">&#39;[LINIDX_2D(3,j,2)] + s[2]; </span><span class="se">\n</span><span class="s">&#39;</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">space</span><span class="o">+</span><span class="n">loc_argname</span><span class="o">+</span><span class="s">&#39;[1] = r1;</span><span class="se">\n</span><span class="s">&#39;</span>
                    
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">space</span><span class="o">+</span><span class="s">&#39;}else{ </span><span class="se">\n</span><span class="s">&#39;</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">space</span><span class="o">+</span><span class="n">loc_argname</span><span class="o">+</span><span class="s">&#39;[1] = &#39;</span><span class="o">+</span><span class="n">argname</span><span class="o">+</span><span class="s">&#39;+3*j;</span><span class="se">\n</span><span class="s">&#39;</span> 
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">space</span><span class="o">+</span><span class="s">&#39;} </span><span class="se">\n</span><span class="s">&#39;</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">space</span><span class="o">+</span><span class="n">loc_argname</span><span class="o">+</span><span class="s">&#39;[0] = &#39;</span><span class="o">+</span><span class="n">argname</span><span class="o">+</span><span class="s">&#39;+3*i;</span><span class="se">\n</span><span class="s">&#39;</span>
                    
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ncomp</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ncomp</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">space</span><span class="o">+</span><span class="s">&#39;double *&#39;</span><span class="o">+</span><span class="n">loc_argname</span><span class="o">+</span><span class="s">&#39;[2];</span><span class="se">\n</span><span class="s">&#39;</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">space</span><span class="o">+</span><span class="n">loc_argname</span><span class="o">+</span><span class="s">&#39;[0] = &#39;</span><span class="o">+</span><span class="n">argname</span><span class="o">+</span><span class="s">&#39;+&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ncomp</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;*i;</span><span class="se">\n</span><span class="s">&#39;</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">space</span><span class="o">+</span><span class="n">loc_argname</span><span class="o">+</span><span class="s">&#39;[1] = &#39;</span><span class="o">+</span><span class="n">argname</span><span class="o">+</span><span class="s">&#39;+&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ncomp</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;*j;</span><span class="se">\n</span><span class="s">&#39;</span>       
        
        <span class="k">return</span> <span class="n">s</span>       
        
     
    <span class="k">def</span> <span class="nf">_update_prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c">#handle perodic bounadies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">domain</span><span class="p">()</span><span class="o">.</span><span class="n">boundary_correct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="p">)</span>
        <span class="c">#update cell list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_sort_all</span><span class="p">()</span>
        
        
<div class="viewcode-block" id="PairLoopRapaport.execute"><a class="viewcode-back" href="../pairloop.html#pairloop.PairLoopRapaport.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        C version of the pair_locate: Loop over all cells update accelerations and potential engery.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_prepare</span><span class="p">()</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">set_accelerations</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">reset_U</span><span class="p">()</span> 
        
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">domain</span><span class="p">()</span><span class="o">.</span><span class="n">cell_array</span><span class="p">()</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">)),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_q_list</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">)),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">domain</span><span class="p">()</span><span class="o">.</span><span class="n">extent</span><span class="p">()</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">))]</span>
                
        <span class="k">for</span> <span class="n">dat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_particle_dat_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">ctypes_data</span><span class="p">())</span>
            
        <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lib</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_kernel</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s">&#39;_wrapper&#39;</span><span class="p">]</span>
        
        <span class="n">method</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">N</span><span class="p">()),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">domain</span><span class="p">()</span><span class="o">.</span><span class="n">cell_count</span><span class="p">()),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>           
        
        
    <span class="c">#move this to C    </span></div>
<div class="viewcode-block" id="PairLoopRapaport.cell_sort_all"><a class="viewcode-back" href="../pairloop.html#pairloop.PairLoopRapaport.cell_sort_all">[docs]</a>    <span class="k">def</span> <span class="nf">cell_sort_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct neighbour list, assigning atoms to cells. Using Rapaport alg.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">cx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">domain</span><span class="p">()</span><span class="o">.</span><span class="n">cell_count</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_q_list</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">N</span><span class="p">()</span> <span class="o">+</span> <span class="n">cx</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">N</span><span class="p">()):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">domain</span><span class="p">()</span><span class="o">.</span><span class="n">get_cell_lin_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">positions</span><span class="p">()</span><span class="o">.</span><span class="n">Dat</span><span class="p">()[</span><span class="n">ix</span><span class="p">,])</span>
            
            <span class="c">#print c, self._pos[ix-1,], self._domain._extent*0.5</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_q_list</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q_list</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">N</span><span class="p">()</span> <span class="o">+</span> <span class="n">c</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_q_list</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_state</span><span class="o">.</span><span class="n">N</span><span class="p">()</span> <span class="o">+</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">ix</span>
            
     </div>
    <span class="k">def</span> <span class="nf">_create_library</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create a shared library from the source code.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="n">filename_base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_temp_dir</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_name</span><span class="p">)</span>
        <span class="n">header_filename</span> <span class="o">=</span> <span class="n">filename_base</span><span class="o">+</span><span class="s">&#39;.h&#39;</span>
        <span class="n">impl_filename</span> <span class="o">=</span> <span class="n">filename_base</span><span class="o">+</span><span class="s">&#39;.c&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">header_filename</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_header_source</span><span class="p">()</span>        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">impl_filename</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_impl_source</span><span class="p">()</span>
        <span class="n">object_filename</span> <span class="o">=</span> <span class="n">filename_base</span><span class="o">+</span><span class="s">&#39;.o&#39;</span>
        <span class="n">library_filename</span> <span class="o">=</span> <span class="n">filename_base</span><span class="o">+</span><span class="s">&#39;.so&#39;</span>        
        <span class="n">cflags</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;-O3&#39;</span><span class="p">,</span><span class="s">&#39;-fpic&#39;</span><span class="p">,</span><span class="s">&#39;-std=c99&#39;</span><span class="p">]</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="s">&#39;gcc&#39;</span>
        <span class="n">ld</span> <span class="o">=</span> <span class="s">&#39;gcc&#39;</span>
        <span class="n">compile_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">cc</span><span class="p">,</span><span class="s">&#39;-c&#39;</span><span class="p">,</span><span class="s">&#39;-fpic&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">cflags</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;-I&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_temp_dir</span><span class="p">]</span> \
                       <span class="o">+</span><span class="p">[</span><span class="s">&#39;-o&#39;</span><span class="p">,</span><span class="n">object_filename</span><span class="p">,</span><span class="n">impl_filename</span><span class="p">]</span>
        <span class="n">link_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">ld</span><span class="p">,</span><span class="s">&#39;-shared&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;-o&#39;</span><span class="p">,</span><span class="n">library_filename</span><span class="p">,</span><span class="n">object_filename</span><span class="p">]</span>
        <span class="n">stdout_filename</span> <span class="o">=</span> <span class="n">filename_base</span><span class="o">+</span><span class="s">&#39;.log&#39;</span>
        <span class="n">stderr_filename</span> <span class="o">=</span> <span class="n">filename_base</span><span class="o">+</span><span class="s">&#39;.err&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">stdout_filename</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stdout</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">stderr_filename</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stderr</span><span class="p">:</span>
                <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;Compilation command:</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">compile_cmd</span><span class="p">))</span>
                <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">compile_cmd</span><span class="p">,</span>
                                     <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span>
                                     <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
                <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;Link command:</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">link_cmd</span><span class="p">))</span>
                <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">link_cmd</span><span class="p">,</span>
                                     <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span>
                                     <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>      
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
     
        
<span class="c">################################################################################################################</span>
<span class="c"># SINGLE PARTICLE LOOP SERIAL</span>
<span class="c">################################################################################################################</span></div>
<div class="viewcode-block" id="SingleAllParticleLoop"><a class="viewcode-back" href="../pairloop.html#pairloop.SingleAllParticleLoop">[docs]</a><span class="k">class</span> <span class="nc">SingleAllParticleLoop</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Class to loop over all particles once.</span>
<span class="sd">    </span>
<span class="sd">    :arg N: (int) Number of elements to loop over.</span>
<span class="sd">    :arg kernel: (class kernel) Kernel to apply at each element.</span>
<span class="sd">    :arg particle_dat_dict: (dict) Dictonary storing map between kernel variables and state variables.</span>
<span class="sd">    :arg headers: (list) list containing C headers required by kernel.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">particle_dat_dict</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span> <span class="o">=</span> <span class="n">N</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_temp_dir</span> <span class="o">=</span> <span class="s">&#39;./build/&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_temp_dir</span><span class="p">)):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_temp_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kernel</span> <span class="o">=</span> <span class="n">kernel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_particle_dat_dict</span> <span class="o">=</span> <span class="n">particle_dat_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nargs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_particle_dat_dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="n">headers</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_code_init</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_unique_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unique_name_calc</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_library_filename</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unique_name</span> <span class="o">+</span><span class="s">&#39;.so&#39;</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_temp_dir</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_library_filename</span><span class="p">))):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_library</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lib</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ctypeslib</span><span class="o">.</span><span class="n">load_library</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_library_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temp_dir</span><span class="p">)</span>

     
        

    <span class="k">def</span> <span class="nf">_create_library</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create a shared library from the source code.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="n">filename_base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_temp_dir</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_name</span><span class="p">)</span>
        <span class="n">header_filename</span> <span class="o">=</span> <span class="n">filename_base</span><span class="o">+</span><span class="s">&#39;.h&#39;</span>
        <span class="n">impl_filename</span> <span class="o">=</span> <span class="n">filename_base</span><span class="o">+</span><span class="s">&#39;.c&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">header_filename</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_header_source</span><span class="p">()</span>        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">impl_filename</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_impl_source</span><span class="p">()</span>
        <span class="n">object_filename</span> <span class="o">=</span> <span class="n">filename_base</span><span class="o">+</span><span class="s">&#39;.o&#39;</span>
        <span class="n">library_filename</span> <span class="o">=</span> <span class="n">filename_base</span><span class="o">+</span><span class="s">&#39;.so&#39;</span>        
        <span class="n">cflags</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;-O3&#39;</span><span class="p">,</span><span class="s">&#39;-fpic&#39;</span><span class="p">]</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="s">&#39;gcc&#39;</span>
        <span class="n">ld</span> <span class="o">=</span> <span class="s">&#39;gcc&#39;</span>
        <span class="n">compile_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">cc</span><span class="p">,</span><span class="s">&#39;-c&#39;</span><span class="p">,</span><span class="s">&#39;-fpic&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">cflags</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;-I&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_temp_dir</span><span class="p">]</span> \
                       <span class="o">+</span><span class="p">[</span><span class="s">&#39;-o&#39;</span><span class="p">,</span><span class="n">object_filename</span><span class="p">,</span><span class="n">impl_filename</span><span class="p">]</span>
        <span class="n">link_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">ld</span><span class="p">,</span><span class="s">&#39;-shared&#39;</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;-o&#39;</span><span class="p">,</span><span class="n">library_filename</span><span class="p">,</span><span class="n">object_filename</span><span class="p">]</span>
        <span class="n">stdout_filename</span> <span class="o">=</span> <span class="n">filename_base</span><span class="o">+</span><span class="s">&#39;.log&#39;</span>
        <span class="n">stderr_filename</span> <span class="o">=</span> <span class="n">filename_base</span><span class="o">+</span><span class="s">&#39;.err&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">stdout_filename</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stdout</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">stderr_filename</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stderr</span><span class="p">:</span>
                <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;Compilation command:</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">compile_cmd</span><span class="p">))</span>
                <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">compile_cmd</span><span class="p">,</span>
                                     <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span>
                                     <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
                <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;Link command:</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">link_cmd</span><span class="p">))</span>
                <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">link_cmd</span><span class="p">,</span>
                                     <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span>
                                     <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>                
        
<div class="viewcode-block" id="SingleAllParticleLoop.execute"><a class="viewcode-back" href="../pairloop.html#pairloop.SingleAllParticleLoop.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Execute the kernel over all particle pairs.&#39;&#39;&#39;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_particle_dat_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dat</span><span class="o">.</span><span class="n">ctypes_data</span><span class="p">())</span>
            
        <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lib</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_kernel</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s">&#39;_wrapper&#39;</span><span class="p">]</span>
        <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_N</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>   
    

       </div>
    <span class="k">def</span> <span class="nf">_generate_impl_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Generate the source code the actual implementation.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;UNIQUENAME&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_name</span><span class="p">,</span>
             <span class="s">&#39;KERNEL_METHODNAME&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_kernel_methodname</span><span class="p">(),</span>
             <span class="s">&#39;KERNEL&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_kernel</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
             <span class="s">&#39;ARGUMENTS&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_argnames</span><span class="p">(),</span>
             <span class="s">&#39;LOC_ARGUMENTS&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_loc_argnames</span><span class="p">(),</span>
             <span class="s">&#39;KERNEL_NAME&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_kernel</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
             <span class="s">&#39;KERNEL_ARGUMENT_DECL&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_kernel_argument_declarations</span><span class="p">()}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_code</span> <span class="o">%</span> <span class="n">d</span>        
        
    
    <span class="k">def</span> <span class="nf">_kernel_methodname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Construct the name of the kernel method.</span>
<span class="sd">        </span>
<span class="sd">        Return a string of the form </span>
<span class="sd">        ``inline void kernel_name(double *&lt;arg1&gt;, double *&lt;arg2}, ...) {``</span>
<span class="sd">        which is used for defining the name of the kernel method.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">space</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">*</span><span class="mi">14</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;inline void &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_kernel</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s">&#39;(&#39;</span>
        <span class="k">for</span> <span class="n">var_name_kernel</span><span class="p">,</span> <span class="n">var_name_state</span>  <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_particle_dat_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c">#print var_name_kernel, var_name_state.dattype()</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;double *&#39;</span><span class="o">+</span><span class="n">var_name_kernel</span><span class="o">+</span><span class="s">&#39;, &#39;</span>
     
        
        
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;) {&#39;</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">_loc_argnames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Comma separated string of local argument names.</span>

<span class="sd">        This string is used in the call to the local kernel. If, for</span>
<span class="sd">        example, two particle dats get passed to the pairloop, then</span>
<span class="sd">        the result will be ``loc_arg_000,loc_arg_001``. Each of these</span>
<span class="sd">        is of type ``double* [2]``, see method _kernel_argument_declarations()</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">argnames</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nargs</span><span class="p">):</span>
            <span class="n">argnames</span> <span class="o">+=</span> <span class="s">&#39;loc_arg_&#39;</span><span class="o">+</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%03d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;,&#39;</span>
        <span class="k">return</span> <span class="n">argnames</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_code_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_code</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">        #include </span><span class="se">\&quot;</span><span class="si">%(UNIQUENAME)s</span><span class="s">.h</span><span class="se">\&quot;</span><span class="s"></span>

<span class="s">        </span><span class="si">%(KERNEL_METHODNAME)s</span><span class="s"></span>
<span class="s">        </span><span class="si">%(KERNEL)s</span><span class="s"></span>
<span class="s">        }</span>

<span class="s">        void </span><span class="si">%(KERNEL_NAME)s</span><span class="s">_wrapper(const int n,</span><span class="si">%(ARGUMENTS)s</span><span class="s">) { </span>
<span class="s">          int i;</span>
<span class="s">          for (i=0; i&lt;n; ++i) {</span>
<span class="s">              </span><span class="si">%(KERNEL_ARGUMENT_DECL)s</span><span class="s"></span>
<span class="s">              </span><span class="si">%(KERNEL_NAME)s</span><span class="s">(</span><span class="si">%(LOC_ARGUMENTS)s</span><span class="s">);</span>
<span class="s">              </span>
<span class="s">            }</span>
<span class="s">        }</span>
<span class="s">        &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">_kernel_argument_declarations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Define and declare the kernel arguments.</span>

<span class="sd">        For each argument the kernel gets passed a pointer of type</span>
<span class="sd">        ``double* loc_argXXX[2]``. Here ``loc_arg[i]`` with i=0,1 is</span>
<span class="sd">        pointer to the data which contains the properties of particle i.</span>
<span class="sd">        These properties are stored consecutively in memory, so for a </span>
<span class="sd">        scalar property only ``loc_argXXX[i][0]`` is used, but for a vector</span>
<span class="sd">        property the vector entry j of particle i is accessed as </span>
<span class="sd">        ``loc_argXXX[i][j]``.</span>

<span class="sd">        This method generates the definitions of the ``loc_argXXX`` variables</span>
<span class="sd">        and populates the data to ensure that ``loc_argXXX[i]`` points to</span>
<span class="sd">        the correct address in the particle_dats.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">dat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_particle_dat_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            
            
            <span class="n">space</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">*</span><span class="mi">14</span>
            <span class="n">argname</span> <span class="o">=</span> <span class="s">&#39;arg_&#39;</span><span class="o">+</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%03d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">loc_argname</span> <span class="o">=</span> <span class="s">&#39;loc_&#39;</span><span class="o">+</span><span class="n">argname</span>
            
            
            <span class="k">if</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dattype</span>  <span class="o">==</span> <span class="s">&#39;scalar&#39;</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">space</span><span class="o">+</span><span class="s">&#39;double *&#39;</span><span class="o">+</span><span class="n">loc_argname</span><span class="o">+</span><span class="s">&#39; = &#39;</span><span class="o">+</span><span class="n">argname</span><span class="o">+</span><span class="s">&#39;;</span><span class="se">\n</span><span class="s">&#39;</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dattype</span>  <span class="o">==</span> <span class="s">&#39;array&#39;</span><span class="p">):</span>
                <span class="n">ncomp</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ncomp</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">space</span><span class="o">+</span><span class="s">&#39;double *&#39;</span><span class="o">+</span><span class="n">loc_argname</span><span class="o">+</span><span class="s">&#39;;</span><span class="se">\n</span><span class="s">&#39;</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">space</span><span class="o">+</span><span class="n">loc_argname</span><span class="o">+</span><span class="s">&#39; = &#39;</span><span class="o">+</span><span class="n">argname</span><span class="o">+</span><span class="s">&#39;+&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ncomp</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;*i;</span><span class="se">\n</span><span class="s">&#39;</span>     
        
        <span class="k">return</span> <span class="n">s</span> 

        
    <span class="k">def</span> <span class="nf">_argnames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Comma separated string of argument name declarations.</span>

<span class="sd">        This string of argument names is used in the declaration of </span>
<span class="sd">        the method which executes the pairloop over the grid. </span>
<span class="sd">        If, for example, the pairloop gets passed two particle_dats, </span>
<span class="sd">        then the result will be ``double* arg_000,double* arg_001`.`</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="n">argnames</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nargs</span><span class="p">):</span>
            <span class="n">argnames</span> <span class="o">+=</span> <span class="s">&#39;double *arg_&#39;</span><span class="o">+</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%03d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;,&#39;</span>
        <span class="k">return</span> <span class="n">argnames</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>        
        
        
        
        
        
    <span class="k">def</span> <span class="nf">_generate_header_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Generate the source code of the header file.</span>

<span class="sd">        Returns the source code for the header file.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">code</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">        #ifndef </span><span class="si">%(UNIQUENAME)s</span><span class="s">_H</span>
<span class="s">        #define </span><span class="si">%(UNIQUENAME)s</span><span class="s">_H </span><span class="si">%(UNIQUENAME)s</span><span class="s">_H</span>

<span class="s">        </span><span class="si">%(INCLUDED_HEADERS)s</span><span class="s"></span>

<span class="s">        void </span><span class="si">%(KERNEL_NAME)s</span><span class="s">_wrapper(int n,</span><span class="si">%(ARGUMENTS)s</span><span class="s">);</span>

<span class="s">        #endif</span>
<span class="s">        &#39;&#39;&#39;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;UNIQUENAME&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_name</span><span class="p">,</span>
             <span class="s">&#39;INCLUDED_HEADERS&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_included_headers</span><span class="p">(),</span>
             <span class="s">&#39;KERNEL_NAME&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_kernel</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
             <span class="s">&#39;ARGUMENTS&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_argnames</span><span class="p">()}</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">code</span> <span class="o">%</span> <span class="n">d</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_included_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return names of included header files.&#39;&#39;&#39;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;#include </span><span class="se">\&quot;</span><span class="s">&#39;</span><span class="o">+</span><span class="n">x</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\&quot;</span><span class="s"> </span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="k">return</span> <span class="n">s</span>
        

    <span class="k">def</span> <span class="nf">_unique_name_calc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return name which can be used to identify the pair loop </span>
<span class="sd">        in a unique way.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kernel</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s">&#39;_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        
<div class="viewcode-block" id="SingleAllParticleLoop.hexdigest"><a class="viewcode-back" href="../pairloop.html#pairloop.SingleAllParticleLoop.hexdigest">[docs]</a>    <span class="k">def</span> <span class="nf">hexdigest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create unique hex digest&#39;&#39;&#39;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
        <span class="n">m</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_kernel</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_code</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="c">################################################################################################################</span>
<span class="c"># SINGLE PARTICLE LOOP OPENMP</span>
<span class="c">################################################################################################################</span>
</div></div>
<div class="viewcode-block" id="SingleAllParticleLoopOpenMP"><a class="viewcode-back" href="../pairloop.html#pairloop.SingleAllParticleLoopOpenMP">[docs]</a><span class="k">class</span> <span class="nc">SingleAllParticleLoopOpenMP</span><span class="p">(</span><span class="n">SingleAllParticleLoop</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    OpenMP version of single pass pair loop (experimental)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">SingleAllParticleLoop</span><span class="o">.</span><span class="n">_create_library</span>
    
    <span class="k">def</span> <span class="nf">_code_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_code</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">        #include </span><span class="se">\&quot;</span><span class="si">%(UNIQUENAME)s</span><span class="s">.h</span><span class="se">\&quot;</span><span class="s"></span>
<span class="s">        #include &lt;omp.h&gt;</span>

<span class="s">        </span><span class="si">%(KERNEL_METHODNAME)s</span><span class="s"></span>
<span class="s">        </span><span class="si">%(KERNEL)s</span><span class="s"></span>
<span class="s">        }</span>

<span class="s">        void </span><span class="si">%(KERNEL_NAME)s</span><span class="s">_wrapper(const int n,</span><span class="si">%(ARGUMENTS)s</span><span class="s">) { </span>
<span class="s">          int i;</span>
<span class="s">          #pragma omp parallel for</span>
<span class="s">          for (i=0; i&lt;n; ++i) {</span>
<span class="s">              </span><span class="si">%(KERNEL_ARGUMENT_DECL)s</span><span class="s"></span>
<span class="s">              </span><span class="si">%(KERNEL_NAME)s</span><span class="s">(</span><span class="si">%(LOC_ARGUMENTS)s</span><span class="s">);</span>
<span class="s">            }</span>
<span class="s">        }</span>
<span class="s">        &#39;&#39;&#39;</span>
    
          
    
    <span class="k">def</span> <span class="nf">_create_library</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create a shared library from the source code.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="n">filename_base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_temp_dir</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_name</span><span class="p">)</span>
        <span class="n">header_filename</span> <span class="o">=</span> <span class="n">filename_base</span><span class="o">+</span><span class="s">&#39;.h&#39;</span>
        <span class="n">impl_filename</span> <span class="o">=</span> <span class="n">filename_base</span><span class="o">+</span><span class="s">&#39;.c&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">header_filename</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_header_source</span><span class="p">()</span>        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">impl_filename</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_impl_source</span><span class="p">()</span>
        <span class="n">object_filename</span> <span class="o">=</span> <span class="n">filename_base</span><span class="o">+</span><span class="s">&#39;.o&#39;</span>
        <span class="n">library_filename</span> <span class="o">=</span> <span class="n">filename_base</span><span class="o">+</span><span class="s">&#39;.so&#39;</span>        
        <span class="n">cflags</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;-O3&#39;</span><span class="p">,</span><span class="s">&#39;-fpic&#39;</span><span class="p">,</span><span class="s">&#39;-fopenmp&#39;</span><span class="p">,</span><span class="s">&#39;-lgomp&#39;</span><span class="p">,</span><span class="s">&#39;-lpthread&#39;</span><span class="p">,</span><span class="s">&#39;-lc&#39;</span><span class="p">,</span><span class="s">&#39;-lrt&#39;</span><span class="p">]</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="s">&#39;gcc&#39;</span>
        <span class="n">ld</span> <span class="o">=</span> <span class="s">&#39;gcc&#39;</span>
        <span class="n">link_flags</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;-fopenmp&#39;</span><span class="p">,</span><span class="s">&#39;-lgomp&#39;</span><span class="p">,</span><span class="s">&#39;-lpthread&#39;</span><span class="p">,</span><span class="s">&#39;-lc&#39;</span><span class="p">,</span><span class="s">&#39;-lrt&#39;</span><span class="p">]</span>
        <span class="n">compile_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">cc</span><span class="p">,</span><span class="s">&#39;-c&#39;</span><span class="p">,</span><span class="s">&#39;-fpic&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">cflags</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;-I&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_temp_dir</span><span class="p">]</span> \
                       <span class="o">+</span><span class="p">[</span><span class="s">&#39;-o&#39;</span><span class="p">,</span><span class="n">object_filename</span><span class="p">,</span><span class="n">impl_filename</span><span class="p">]</span>
        <span class="n">link_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">ld</span><span class="p">,</span><span class="s">&#39;-shared&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">link_flags</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;-o&#39;</span><span class="p">,</span><span class="n">library_filename</span><span class="p">,</span><span class="n">object_filename</span><span class="p">]</span>
        <span class="n">stdout_filename</span> <span class="o">=</span> <span class="n">filename_base</span><span class="o">+</span><span class="s">&#39;.log&#39;</span>
        <span class="n">stderr_filename</span> <span class="o">=</span> <span class="n">filename_base</span><span class="o">+</span><span class="s">&#39;.err&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">stdout_filename</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stdout</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">stderr_filename</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stderr</span><span class="p">:</span>
                <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;Compilation command:</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">compile_cmd</span><span class="p">))</span>
                <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">compile_cmd</span><span class="p">,</span>
                                     <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span>
                                     <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
                <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;Link command:</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">link_cmd</span><span class="p">))</span>
                <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">link_cmd</span><span class="p">,</span>
                                     <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span>
                                     <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span> 
        
        
        


















        
    
    </div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">src  documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, Author.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>